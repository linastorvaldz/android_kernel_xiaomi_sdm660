name: æ‰¹é‡æ¢å¤æäº¤

on:
  workflow_dispatch:
    inputs:
      target-repo:
        description: "ç›®æ ‡ä»“åº“çš„URLï¼ˆæ ¼å¼ï¼šowner/repoï¼‰"
      target-branch:
        description: "ç›®æ ‡ä»“åº“çš„åˆ†æ”¯åç§°"
        default: "main"
      commit-hashes: # ä¿®æ”¹è¾“å…¥æè¿°ï¼Œè¯´æ˜ä½¿ç”¨é€—å·åˆ†éš”
        description: "éœ€è¦æ¢å¤çš„æäº¤å“ˆå¸Œå€¼åˆ—è¡¨ (ä½¿ç”¨é€—å·åˆ†éš”)"
        type: string
      username:
        description: "GitHubç”¨æˆ·å"
      password:
        description: "GitHubå¯†ç "
        required: false
      use-pat:
        description: "æ˜¯å¦ä½¿ç”¨PATè®¤è¯"
        default: "false"
      revert-type:
        description: "æ¢å¤ç±»å‹ï¼š'revert'ï¼ˆé»˜è®¤ï¼‰æˆ– 'reset'"
        default: "revert"

jobs:
  revert:
    runs-on: ubuntu-latest
    steps:
      - name: Checkoutä»“åº“ï¼ˆå®Œæ•´å†å²ï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # æ‹‰å–å®Œæ•´æäº¤å†å²

      - name: éªŒè¯è¾“å…¥æ ¼å¼
        run: |
          # æ£€æŸ¥target-repoæ ¼å¼æ˜¯å¦ä¸ºowner/repo
          if [[ ! "${{ github.event.inputs.target-repo }}" =~ ^[a-zA-Z0-9_-]+/[a-zA-Z0-9_-]+$ ]]; then
            echo "::error::ä»“åº“æ ¼å¼é”™è¯¯ï¼è¯·ä½¿ç”¨ 'owner/repo' æ ¼å¼"
            exit 1
          fi

          # æ£€æŸ¥ commit-hashes æ˜¯å¦ä¸ºç©º
          if [ -z "${{ github.event.inputs.commit-hashes }}" ]; then
            echo "::error::å¿…é¡»æä¾›è‡³å°‘ä¸€ä¸ªæäº¤å“ˆå¸Œå€¼"
            exit 1
          fi

          # æ£€æŸ¥æ¯ä¸ª commit-hash æ˜¯å¦ä¸º40ä½å“ˆå¸Œ (é€—å·åˆ†éš”)
          IFS=',' read -r -a commit_hash_array <<< "${{ github.event.inputs.commit-hashes }}"
          for hash in "${commit_hash_array[@]}"; do
            hash_trimmed=$(echo "$hash" | xargs) # å»é™¤å“ˆå¸Œå‰åçš„ç©ºæ ¼
            if [[ ! "$hash_trimmed" =~ ^[0-9a-f]{40}$ ]]; then
              echo "::error::æäº¤å“ˆå¸Œæ ¼å¼æ— æ•ˆ: $hash_trimmed"
              exit 1
            fi
          done

      - name: è°ƒè¯•è¾“å…¥å‚æ•°
        run: |
          echo "ç›®æ ‡ä»“åº“: ${{ github.event.inputs.target-repo }}"
          echo "ç›®æ ‡åˆ†æ”¯: ${{ github.event.inputs.target-branch }}"
          echo "æ¢å¤æäº¤åˆ—è¡¨:"
          echo "${{ github.event.inputs.commit-hashes }}"
          echo "ä½¿ç”¨PAT: ${{ github.event.inputs.use-pat }}"
          echo "æ¢å¤ç±»å‹: ${{ github.event.inputs.revert-type }}"

      - name: é…ç½®Gitèº«ä»½
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"

      - name: æ·»åŠ è¿œç¨‹ä»“åº“
        run: |
          git remote remove other-repo || true  # é˜²æ­¢é‡å¤æ·»åŠ 

          if [ "${{ github.event.inputs.use-pat }}" = "true" ]; then
            git remote add other-repo "https://${{ secrets.PAT }}@github.com/${{ github.event.inputs.target-repo }}.git"
          else
            git remote add other-repo "https://${{ github.event.inputs.username }}:${{ github.event.inputs.password }}@github.com/${{ github.event.inputs.target-repo }}.git"
          fi

      - name: éªŒè¯è¿œç¨‹åˆ†æ”¯å­˜åœ¨æ€§
        run: |
          if ! git ls-remote --exit-code --heads other-repo "${{ github.event.inputs.target-branch }}"; then
            echo "::error::ç›®æ ‡åˆ†æ”¯ä¸å­˜åœ¨æˆ–æ— æƒè®¿é—®"
            exit 1
          fi

      - name: æ‹‰å–ç›®æ ‡æäº¤
        run: |
          export GIT_TRACE=1
          git fetch --progress other-repo "${{ github.event.inputs.target-branch }}"

      - name: æ‰¹é‡æ¢å¤æäº¤
        run: |
          set -x  # å¯ç”¨å‘½ä»¤å›æ˜¾
          IFS=',' read -r -a commit_hash_array <<< "${{ github.event.inputs.commit-hashes }}"
          for commit_hash in "${commit_hash_array[@]}"; do
            commit_hash_trimmed=$(echo "$commit_hash" | xargs) # å»é™¤å“ˆå¸Œå‰åçš„ç©ºæ ¼
            echo "å¤„ç†æäº¤å“ˆå¸Œ: $commit_hash_trimmed"
            if [ "${{ github.event.inputs.revert-type }}" = "revert" ]; then
              echo "ğŸ”„ ä½¿ç”¨ git revert æ¢å¤æäº¤: $commit_hash_trimmed"
              git revert -m 1 "$commit_hash_trimmed"
            elif [ "${{ github.event.inputs.revert-type }}" = "reset" ]; then
              echo "âš ï¸  ä½¿ç”¨ git reset --hard æ¢å¤æäº¤: $commit_hash_trimmed"
              git reset --hard "$commit_hash_trimmed"
            else
              echo "::error::æ— æ•ˆçš„æ¢å¤ç±»å‹ï¼è¯·é€‰æ‹© 'revert' æˆ– 'reset'"
              exit 1
            fi
          done

      - name: æ¨é€å˜æ›´
        if: success()
        run: |
          # ä½¿ç”¨å¼ºåˆ¶æ¨é€ä»¥è¦†ç›–ç›®æ ‡åˆ†æ”¯
          git push --force-with-lease origin HEAD:"${{ github.event.inputs.target-branch }}"
